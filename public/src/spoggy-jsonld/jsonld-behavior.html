
<script>
/* @polymerMixin */
var JsonldBehaviorMixin = Polymer.dedupingMixin(function(superClass){
  return class JsonldBehavior extends superClass {
    constructor() {
      super();
      //  console.log("Mode behavior")
      //  console.log(this.inputProp);
    }

    static get properties() {
      return {
        inputProp: {
          type: String,
          value: 'modeB'
        }
      };
    }

    requestJsonLd(params){
      //exemple    http://127.0.0.1:8080/?format=jsonld&endpoint=http://163.172.179.125:9112/sparql&uri=http://semantic-forms.cc:9112/ldp/1507730036573-23410983362747940
      console.log(params);


      let options = {
        query: 'PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\
        PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#>\
        PREFIX foaf: <http://xmlns.com/foaf/0.1/>\
        CONSTRUCT { ?S ?P ?O . } WHERE { GRAPH ?G { ?S ?P ?O . } } LIMIT 10',
        format: 'application/sparql-results+json',
        //  format: 'json',
      }
      console.log(options)
      this.$.fetch.url = params.endpoint;
      this.$.fetch.params = options;
      this.$.fetch.generateRequest().completes.then(function(req,resp) {
        console.log(req);
        console.log(resp);
        console.log(req.response)
        var data = req.response;
        let response = JSON.parse(data);
      });
    }


    complementaire(node){
      console.log(node);
      if(node.type == "Literal"){
        console.log("Node est un Literal");
      }else{
        let options = {
          /*  query: 'PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\
          PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#>\
          PREFIX foaf: <http://xmlns.com/foaf/0.1/>\
          CONSTRUCT { ?S ?P ?O . } WHERE { GRAPH ?G { ?S ?P ?O . } } LIMIT 10',*/
          query:  'PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> \
          SELECT * \
          WHERE {\
            { <'+node.url+'> ?p ?o . \
          }\
          UNION \
          { ?s ?p <'+node.url+'> . \
        } \
      }   LIMIT 100',
      unionDefaultGraph: 'on',
    //  format: 'application/sparql-results+json',
      //  format: 'json',
    }
    console.log(options)
    this.$.fetch.url = node.sparql+"/sparql";
    this.$.fetch.params = options;
    this.$.fetch.generateRequest().completes.then(function(req,resp) {
      console.log(req);
      console.log(resp);
      console.log(req.response)
      var data = req.response;
      let response = JSON.parse(data);
    });
  }
}


loadJsonLd(data){
  var url = data.url;
  this.sparql = data.sparql;
  // exemple  http://127.0.0.1:8080/?jsonld=http%3A%2F%2Fsemantic-forms.cc%3A9112%2Fldp%2F1507730036573-23410983362747940
  if (url != null) {
    console.log(url);
    this.rdfURL2SimpleArray(url)
  } else
  console.log("No url= in jsonld ");
}

/*    loadJsonLd(url){
if (url != null) {
console.log(url);

let options = {
//  query: exploreQuery.query,
format: 'application/sparql-results+json',
//  format: 'json',
}
console.log(options)
this.$.fetch.url = url;
this.$.fetch.params = options;
this.$.fetch.generateRequest().completes.then(function(req,resp) {
console.log(req);
console.log(resp);
console.log(req.response)
var data = req.response;
let response = JSON.parse(data);
});
*/

rdfURL2SimpleArray(/*String: */url)/*: Promise*/ {
  return rdfFetch( url ).then(
    (res) => {
      //    console.log( 'FETCH ' + res );
      return res.dataset()
    }).then((dataset) => {
      console.log(dataset);
      var quads= dataset._quads;
      console.log(quads);


      var visResults =   this.parseToVis(quads)
      this.agentJsonld.send('agentGraph', {type: "resultsFromPersee", results: visResults})

    });

  }

  parseToVis(quads){
    var app = this;
    var visRes = {nodes:[], edges:[]};
    quads.forEach(function(q){
      var s = q.subject;
      var p = q.predicate;
      var o = q.object;
      var g = q.graph;
      let node = {
        id: s.value,
        type: s.termType,
        //  resourceType: typeResources.s,
        url: s.value,
        label: app.visLabel(s.value),
        sparql: app.sparql,
        //  title: r.s.value,
        //  endpointUrl: endpointUrl,
        color: "rgb(76,0,74)",
        font: {
          color: 'rgb(255,255,255)'
        },
        //  cid: group,
        y: 100,
        x:100,
      }
      var trouveN = visRes.nodes.find(function(element){
        return node.id == element.id
      });
      if (trouveN) {
        //  console.log("TROUVE ")
        //  console.log(trouveN)
        node = trouveN;
      }else{
        visRes.nodes.push(node);
      }



      let nodeO = {
        id: o.value ,
        type: o.termType ,
        //  resourceType: typeResources.sub,
        url: o.value,
        sparql: app.sparql,
        //label: app.visLabel(r.subj.value),
        //  label : ,
        //  endpointUrl: endpointUrl,


        //cid: group,
        //  y: 2*Math.random()
      }
      if (app.visLabel(o.value).length > 40){
        var lab = app.visLabelSplit(app.visLabel(o.value))
        nodeO.label = lab.substr(0, 37)+" ...";
        nodeO.title = lab;
      }else{
        nodeO.label = app.visLabel(o.value);
      }
      if (o.termType == "Literal"){
        nodeO.color= "rgb(107,142,35)";
        nodeO.shape= "box";
      }else{
        if (nodeO.id.includes("ldp")){
          nodeO.color= "rgb(76,0,74)";
        }else{
          nodeO.color= "rgba(76,0,74,.5)";
        }

        nodeO.font= {};
        nodeO.font.color = 'rgb(255,255,255)';
        //  nodeO.shape = "ellipse";
        console.log(nodeO);
      }

      var trouveO = visRes.nodes.find(function(element){
        return nodeO.id == element.id
      });
      if (trouveO) {
        //  console.log("TROUVE ")
        //  console.log(trouveS)
        nodeO = trouveO;
      }else{
        visRes.nodes.push(nodeO);
      }

      let  eType = {from : node.id, to: nodeO.id, label: app.visLabel(p.value), type: p.termType};
      var trouveE = visRes.edges.find(function(e){
        return eType.from == e.from && eType.to == e.to && eType.label == e.label;
      })
      if(trouveE){
        eType = trouveE;
      } else{
        visRes.edges.push(eType);
      }


    });

    return visRes;
  }

  visLabel(texte){
    /// FONCTION GENERALISTE DE NETTOYAGE DES LABELS
    let text = texte.trim();
    text = text.replace('#Web','').replace('#Print','').replace('#Person',''); // Pour nettoyer les ressources Persee
    let result = "";
    let textCut = text.split("#");
    result = textCut[textCut.length-1];
    if (result == text){
      textCut = text.split("/");
      result = textCut[textCut.length-1];
    }
    if (result == text){
      textCut = text.split("/");
      result = textCut[textCut.length-2];
    }
    if(result == undefined || result.length == 0){
      result = text;
    }
    //  console.log(texte + "->"+result);
    return result
  }
  visLabelSplit(texte){
    if (texte.length > 40){
      //  texte = texte.split("<br>").join("\n").split("&nbsp;").join(" ");
      return texte.match(/.{1,40}/g).join("\n");
    }else{
      return texte;
    }
  }

}
});

</script>
